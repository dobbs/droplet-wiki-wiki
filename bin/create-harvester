#!/bin/bash
set -euo pipefail
ITS=$'\n\r\t'

main() {
  remote-create-user-account
}

remote-create-user-account() {
  local PUBKEY=$(cat ~/.ssh/wiki-wiki/harvester-id_ecdsa.pub)
  ssh wiki-wiki <<EOF
if ! id harvester 2>/dev/null; then
  useradd harvester --create-home --shell /bin/bash --groups sudo,docker
else
  echo "user account (harvester) already exists"
fi

if [ ! -d ~harvester/.ssh ]; then
  mkdir ~harvester/.ssh
  echo "$PUBKEY" > ~harvester/.ssh/authorized_keys
  chown -R harvester:harvester ~harvester/.ssh
  chmod 700 ~harvester/.ssh
  chmod 600 ~harvester/.ssh/authorized_keys
fi

EOF
}

main "$@"
